<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ³¨å†Œè¡¨å•</title>
</head>
<body>
  <h2>æ³¨å†Œä¿¡æ¯å¡«å†™</h2>

  <div id="login-section">
    <button onclick="loginWithGitHub()">ä½¿ç”¨ GitHub ç™»å½•</button>
  </div>

  <div id="form-section" style="display: none;">
    <p>æ¬¢è¿ï¼Œ<span id="username"></span>ï¼è¯·å¡«å†™ä»¥ä¸‹å†…å®¹ï¼š</p>
    <form id="reg-form">
      <label>å§“åï¼š<input name="name" required /></label><br />
      <label>é‚®ç®±ï¼š<input type="email" name="email" required /></label><br />
      <label>è‡ªæˆ‘ä»‹ç»ï¼š<br />
        <textarea name="intro" rows="5" cols="50"></textarea>
      </label><br />
      <button type="submit">æäº¤æ³¨å†Œ</button>
    </form>
    <p id="msg"></p>
  </div>

  <script>
    const clientId = 'Ov23liqejWO1JmeypiSN';
    const repoOwner = 'szuns2022';
    const repoName = 'page';

    function loginWithGitHub() {
      const redirectUri = 'https://authflow.js.org/callback.html';
      const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=public_repo`;
      window.location.href = authUrl;
    }

    async function checkAuth() {
      const hash = window.location.hash;
      const tokenMatch = hash.match(/access_token=([\w-]+)/);
      if (!tokenMatch) return;

      const accessToken = tokenMatch[1];
      const user = await fetch('https://api.github.com/user', {
        headers: { Authorization: `token ${accessToken}` }
      }).then(res => res.json());

      document.getElementById('username').innerText = user.login;
      document.getElementById('form-section').style.display = 'block';
      document.getElementById('login-section').style.display = 'none';

      document.getElementById('reg-form').onsubmit = async function (e) {
        e.preventDefault();
        document.getElementById('msg').innerText = 'æ­£åœ¨æäº¤ä¸­...';

        const name = this.name.value;
        const email = this.email.value;
        const intro = this.intro.value;

        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/issues`, {
          method: 'POST',
          headers: {
            Authorization: `token ${accessToken}`,
            Accept: 'application/vnd.github+json'
          },
          body: JSON.stringify({
            title: `æ³¨å†Œï¼š${name}`,
            body: `**é‚®ç®±**: ${email}\n\n**è‡ªæˆ‘ä»‹ç»**:\n${intro}`,
            labels: ['register']
          })
        });

        if (res.ok) {
          document.getElementById('msg').innerText = 'ğŸ‰ æ³¨å†ŒæˆåŠŸï¼';
          this.reset();
        } else {
          document.getElementById('msg').innerText = 'âŒ æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
        }
      };
    }

    window.onload = checkAuth;
  </script>
</body>
</html>

